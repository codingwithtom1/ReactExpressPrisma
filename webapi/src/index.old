import express, { Express, Request, Response } from "express";
import dotenv from "dotenv";
import indexRouter from "./routes/index.routes";
import jwt from "jsonwebtoken";


dotenv.config();

const app: Express = express();
const port = process.env.PORT || 3000;
const key = process.env.SECRETKEY || "nokey";

app.post("/login",
    async (req, res, next) => {
        let { email, password } = req.body;
 
        let existingUser;
        try {
          // look up in database
            existingUser = { email: "tom@test.com", password:"password", id: 1};
                
        } catch {
            const error =
                new Error(
                    "Error! Something went wrong."
                );
            return next(error);
        }
        if (!existingUser
            || existingUser.password
            != password) {
            const error =
                Error(
                    "Wrong details please check at once"
                );
            return next(error);
        }
        let token;
        try {
            //Creating jwt token
            token = jwt.sign(
                {
                    userId: existingUser.id,
                    email: existingUser.email
                },
                key,
                { expiresIn: "1h" }
            );
        } catch (err) {
            console.log(err);
            const error =
                new Error("Error! Something went wrong.");
            return next(error);
        }
 
        res
            .status(200)
            .json({
                success: true,
                data: {
                    userId: existingUser.id,
                    email: existingUser.email,
                    token: token,
                },
            });
    });





app.listen(port, () => {
  console.log(`[server]: Server is running at http://localhost:${port}`);
});
